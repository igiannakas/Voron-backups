#####################################################################
#   Happy Hare includes
#####################################################################
[include mmu/base/*.cfg]
[include mmu/optional/mmu_menu.cfg]
[include mmu/addons/mmu_eject_buttons.cfg]

#####################################################################
#   File locations and on error handling
#####################################################################

[virtual_sdcard]
path: /home/pi/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

 
#####################################################################
#   Device ID's
#####################################################################
[mcu]
canbus_uuid: c0f599d7bb14
canbus_interface: can1

[mcu EBBCan]
canbus_uuid: cd407005594f 
canbus_interface: can1

# canbus_uuid: 7d06e01afee5 # Stealthburner
# MMU: b9552979a1b0

#####################################################################
#   Basic Klipper and Printer setup
#####################################################################

[printer]
kinematics: corexy
max_velocity: 500
max_accel: 20000   	
max_z_velocity: 35		
max_z_accel: 300	
square_corner_velocity: 5
minimum_cruise_ratio: 0.0

[exclude_object]
[print_stats]

[gcode_arcs]
resolution: 0.05

[idle_timeout]
timeout: 3600

[force_move]
enable_force_move: True


#####################################################################
#   Includes
#####################################################################

## Configuration files
[include mainsail.cfg]
[include config/stealthburner_leds.cfg]
[include config/extruder.cfg]
[include config/steppers.cfg]
[include config/temperature_sensors.cfg]
[include config/homing.cfg]
[include config/fans.cfg]
[include config/disco.cfg]
[include config/input_shaper.cfg]
[include config/display.cfg]

## Macros
[include macros/stealthmax_macros.cfg]
[include macros/movement_macros.cfg]
[include macros/LED_macros.cfg]
[include macros/printing_macros.cfg]
[include macros/print_start_end.cfg]

## Cartographer macro
[include macros/cartographer_macros.cfg]

## MMU Macros
[include mmu/optional/client_macros.cfg]
[include mmu/addons/blobifier.cfg]
[include macros/custom_blobifier.cfg]
[include macros/custom_mmu_macros.cfg]

[include macros/emu_macros.cfg]


[temperature_sensor toolhead_board]
sensor_type: temperature_mcu
sensor_mcu: EBBCan
min_temp: 0
max_temp: 140


#[display MMU_LANE_0]
#lcd_type: ssd1306
#i2c_mcu: mmu2
#i2c_software_scl_pin: mmu2:PB3
#i2c_software_sda_pin: mmu2:PB4
#display_group: mmu_env


#[display_data mmu_env line0]
#position: 0,0
#text:
#  RH: { printer["bme280 Lane_0"].humidity|float|round(1) } %

#[display_data mmu_env line1]
#position: 1,0
#text:
#  Spool: { {0:'Empty',1:'Avail.',2:'Avail.',-1:'Unknown'}[printer.mmu.gate_status[0]|int] }

# THIRD LINE → show only when gate 0 is selected; if Unloaded, show material instead
#[display_data mmu_env line2]
#position: 2,0
#text:
#  { "Fil: Loaded" if (printer.mmu.gate|int == 0 and printer.mmu.filament == 'Loaded')
#    else ("Fil: " ~ (printer.mmu.gate_material[0]|default('—'))) }


# LAST LINE → operation (if not empty) else print state; if both empty -> Idle; only when gate 0 selected, else "--"
#[display_data mmu_env line3]
#position: 3,0
#text:
#  { 
#    (
#      printer.mmu.operation
#      if printer.mmu.operation
#      else (
#        printer.mmu.print_job_state
#        if printer.mmu.print_job_state
#        else (printer.mmu.print_state if printer.mmu.print_state else "Idle")
#      )
#    )
#    if (printer.mmu.gate|int == 0) else "--"
#  }



[gcode_macro MMU_DEBUG]
description: Show key MMU state in console
gcode:
  RESPOND MSG="Op: {printer.mmu.operation}"
  RESPOND MSG="Gate: {printer.mmu.gate}"
  RESPOND MSG="Print state: {printer.mmu.print_job_state}"
  RESPOND MSG="Filament: {printer.mmu.filament}"



#####################################################################
#   Stepper current delayed gcode and notification infrastructure
#####################################################################

[gcode_macro MR_NOTIFY]
description: Allows you to send a custom notification via Mobileraker without using the M117 command
gcode:
    {% set msg = "MR_NOTIFY:" ~ (params.TITLE ~ "|" if 'TITLE' in params|upper else "") ~ params.MESSAGE %}

    {% if 'MESSAGE' in params|upper %}
        { action_respond_info(msg) }
    {% else %}
        { action_raise_error('Must provide MESSAGE parameter') }
    {% endif %}

[delayed_gcode INITIALISATION_MACROS] 
initial_duration: 3
gcode:
  _SET_PRINT_CURRENT
  M84
  M400
  REFRESH_SPOOLMAN
  M400
  update_git
  M400

[gcode_macro update_git]
gcode:
  RUN_SHELL_COMMAND CMD=update_git_script

[gcode_shell_command update_git_script]
command: bash -c "bash $HOME/klipper-backup/script.sh"
timeout: 180.0
verbose: False

## Timelapse
[include timelapse.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 27.137
#*# pid_ki = 2.783
#*# pid_kd = 66.144
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 63.172
#*# pid_ki = 4.342
#*# pid_kd = 229.789
#*#
#*# [cartographer touch_model default]
#*# threshold = 2250
#*# speed = 2
#*# z_offset = -0.080
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.042719, 0.047946, 0.045334, 0.044126, 0.045534, 0.041610, 0.041610, 0.045534, 0.050655, 0.055765, 0.060963, 0.060963, 0.055765, 0.050754, 0.046740, 0.042919, 0.041610, 0.040301, 0.044126, 0.050655, 0.051958
#*# 	  0.048146, 0.055765, 0.054463, 0.055765, 0.053360, 0.053161, 0.051958, 0.049450, 0.050555, 0.054563, 0.058365, 0.058365, 0.054463, 0.050754, 0.048146, 0.045534, 0.044126, 0.045534, 0.045534, 0.047946, 0.048146
#*# 	  0.040301, 0.045534, 0.046740, 0.047946, 0.045434, 0.040301, 0.038991, 0.037681, 0.037681, 0.035157, 0.040301, 0.040301, 0.037681, 0.035057, 0.031214, 0.025946, 0.022091, 0.020670, 0.021889, 0.024729, 0.025946
#*# 	  0.025946, 0.033844, 0.033744, 0.033844, 0.032431, 0.029796, 0.027365, 0.023309, 0.022091, 0.022091, 0.024629, 0.022091, 0.022091, 0.022091, 0.016806, 0.008957, 0.006403, 0.006200, 0.007629, 0.011509, 0.014260
#*# 	  0.027264, 0.032431, 0.032431, 0.029896, 0.027365, 0.027365, 0.022091, 0.019450, 0.019450, 0.018229, 0.018128, 0.017008, 0.018128, 0.016806, 0.014159, 0.007629, 0.003744, 0.001082, 0.003744, 0.009059, 0.008856
#*# 	  0.029997, 0.040301, 0.038891, 0.036369, 0.031113, 0.027264, 0.023410, 0.020670, 0.018027, 0.019450, 0.022091, 0.022091, 0.019450, 0.015482, 0.014159, 0.011509, 0.007629, 0.003540, 0.006301, 0.010284, 0.014159
#*# 	  0.040301, 0.047946, 0.045534, 0.040301, 0.035258, 0.032531, 0.027365, 0.025946, 0.022091, 0.022091, 0.025946, 0.029796, 0.027365, 0.023309, 0.022091, 0.016806, 0.012935, 0.010284, 0.012834, 0.016804, 0.018229
#*# 	  0.032631, 0.038991, 0.036469, 0.036469, 0.029896, 0.023410, 0.020670, 0.016906, 0.012935, 0.012935, 0.016907, 0.019551, 0.020670, 0.019450, 0.012834, 0.007731, 0.002311, -0.000352, 0.001082, 0.006403, 0.010284
#*# 	  0.027264, 0.035057, 0.032431, 0.029896, 0.024729, 0.016806, 0.011509, 0.005073, 0.002311, 0.002311, 0.006403, 0.011711, 0.012834, 0.010284, 0.003744, -0.001686, -0.004252, -0.008259, -0.005586, -0.000251, -0.004152
#*# 	  0.025946, 0.036469, 0.035057, 0.031214, 0.023410, 0.015482, 0.008956, 0.003641, -0.000251, 0.002413, 0.005073, 0.010284, 0.010182, 0.010182, 0.004870, 0.002311, -0.001583, -0.004252, -0.001583, 0.002311, 0.008856
#*# 	  0.019450, 0.027163, 0.027365, 0.024729, 0.016806, 0.006403, 0.002311, -0.002917, -0.006822, -0.004251, -0.000352, 0.001080, 0.002413, 0.002311, -0.003019, -0.006923, -0.008159, -0.009597, -0.009498, -0.006923, -0.009596
#*# 	  0.021990, 0.031314, 0.032426, 0.028681, 0.023410, 0.016906, 0.010385, 0.006200, 0.000979, 0.002413, 0.008956, 0.011711, 0.012935, 0.010284, 0.007731, 0.004870, 0.002311, -0.000251, 0.000979, 0.003642, 0.006200
#*# 	  0.022091, 0.029796, 0.032431, 0.031214, 0.023410, 0.014260, 0.008856, 0.004870, -0.000251, -0.000251, 0.003641, 0.007528, 0.010284, 0.010182, 0.007629, 0.004870, 0.001180, -0.001686, 0.000979, 0.002413, 0.003744
#*# 	  0.022091, 0.031113, 0.028580, 0.027163, 0.021990, 0.011610, 0.004972, -0.000251, -0.001686, -0.000352, -0.000251, 0.003641, 0.007528, 0.005073, 0.004972, -0.000251, -0.002818, -0.002917, -0.001686, 0.001082, 0.003642
#*# 	  0.032631, 0.042919, 0.040301, 0.035157, 0.029997, 0.023309, 0.018128, 0.011509, 0.008856, 0.010385, 0.012834, 0.016906, 0.016805, 0.015584, 0.015482, 0.012935, 0.011609, 0.007731, 0.008956, 0.012932, 0.010182
#*# 	  0.029997, 0.038991, 0.037681, 0.036369, 0.031113, 0.024729, 0.020771, 0.016806, 0.014157, 0.014159, 0.018128, 0.022091, 0.023309, 0.023410, 0.022091, 0.020670, 0.018128, 0.012935, 0.015482, 0.016806, 0.019450
#*# 	  0.024629, 0.035057, 0.037681, 0.035157, 0.035057, 0.027365, 0.020670, 0.018128, 0.016806, 0.019450, 0.023309, 0.028580, 0.028580, 0.025946, 0.025946, 0.023410, 0.020670, 0.018128, 0.019449, 0.019550, 0.016806
#*# 	  0.028580, 0.038991, 0.042919, 0.041610, 0.037681, 0.033844, 0.027365, 0.024627, 0.022091, 0.022091, 0.027264, 0.031113, 0.033844, 0.036369, 0.033844, 0.032531, 0.027365, 0.025845, 0.027163, 0.027365, 0.029997
#*# 	  0.036469, 0.045534, 0.047946, 0.045334, 0.040301, 0.035057, 0.027365, 0.022091, 0.019450, 0.019551, 0.025946, 0.028580, 0.032531, 0.035057, 0.035056, 0.032531, 0.029898, 0.028580, 0.028580, 0.035057, 0.035057
#*# 	  0.045534, 0.058365, 0.058365, 0.055765, 0.051958, 0.046740, 0.035057, 0.032431, 0.029997, 0.032431, 0.037781, 0.040301, 0.042919, 0.045434, 0.048046, 0.048146, 0.045534, 0.042919, 0.042919, 0.051958, 0.057167
#*# 	  0.045534, 0.053261, 0.053161, 0.053161, 0.048146, 0.042819, 0.035057, 0.028580, 0.029796, 0.029796, 0.036469, 0.040301, 0.042819, 0.045534, 0.047946, 0.048146, 0.040301, 0.035157, 0.040301, 0.049350, 0.055765
#*# min_x = 20.0
#*# min_y = 22.0
#*# max_x = 330.0
#*# max_y = 330.0
#*# x_count = 21
#*# y_count = 21
#*# mesh_x_pps = 0
#*# mesh_y_pps = 0
#*# algo = bicubic
#*# tension = 0.2
#*#
#*# [cartographer]
#*# z_backlash = 0.01338
#*#
#*# [cartographer scan_model default]
#*# coefficients = 1.4047530202133927,1.8755943256721153,0.8258982854149256,0.3460748619092427,0.5315659462392147,0.787064521239427,-0.41235073827935415,-0.8851744967638143,0.4483841374594059,0.5762901419445466
#*# domain = 3.1862048998498217e-07,3.3292898966312154e-07
#*# z_offset = 0
#*# reference_temperature = 24.12
