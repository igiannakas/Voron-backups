#####################################################################
#   Happy Hare includes
#####################################################################
[include mmu/base/*.cfg]
[include mmu/optional/mmu_menu.cfg]
[include mmu/addons/mmu_eject_buttons.cfg]

#####################################################################
#   File locations and on error handling
#####################################################################

[virtual_sdcard]
path: /home/pi/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

 
#####################################################################
#   Device ID's
#####################################################################
[mcu]
canbus_uuid: c0f599d7bb14
canbus_interface: can1

[mcu EBBCan]
canbus_uuid: cd407005594f 
canbus_interface: can1

# canbus_uuid: 7d06e01afee5 # Stealthburner
# MMU: b9552979a1b0

#####################################################################
#   Basic Klipper and Printer setup
#####################################################################

[printer]
kinematics: corexy
max_velocity: 500
max_accel: 20000   	
max_z_velocity: 35		
max_z_accel: 300	
square_corner_velocity: 5
minimum_cruise_ratio: 0.0

[exclude_object]
[print_stats]

[gcode_arcs]
resolution: 0.05

[idle_timeout]
timeout: 3600

[force_move]
enable_force_move: True


#####################################################################
#   Includes
#####################################################################

## Configuration files
[include mainsail.cfg]
[include config/stealthburner_leds.cfg]
[include config/extruder.cfg]
[include config/steppers.cfg]
[include config/temperature_sensors.cfg]
[include config/homing.cfg]
[include config/fans.cfg]
[include config/disco.cfg]
[include config/input_shaper.cfg]
[include config/display.cfg]

## Macros
[include macros/stealthmax_macros.cfg]
[include macros/movement_macros.cfg]
[include macros/LED_macros.cfg]
[include macros/printing_macros.cfg]
[include macros/print_start_end.cfg]

## Cartographer macro
[include macros/cartographer_macros.cfg]

## MMU Macros
[include mmu/optional/client_macros.cfg]
[include mmu/addons/blobifier.cfg]
[include macros/custom_blobifier.cfg]
[include macros/custom_mmu_macros.cfg]



[mcu fps]
canbus_uuid: 64af92021bd9 

[fps my_feedback_sensor]
pin: fps:PA2
sample_count: 5 
sample_time: 0.005
report_time: 0.100
reversed: False
set_point: 0.5 
happy_hare_sync: True 
use_kalico: False 

[gcode_macro QUERY_FPS]
gcode:
  M118 FPS Value: { printer["fps my_feedback_sensor"].fps_value|float|round(3) }


[temperature_sensor Lane_0]
sensor_type: BME280
bme280_report_time: 10
i2c_address: 118
i2c_mcu: mmu0
i2c_software_scl_pin: mmu0:PB3
i2c_software_sda_pin: mmu0:PB4

[temperature_sensor Lane_1]
sensor_type: BME280
bme280_report_time: 10
i2c_address: 118
i2c_mcu: mmu1
i2c_software_scl_pin: mmu1:PB3
i2c_software_sda_pin: mmu1:PB4

[temperature_sensor Lane_2]
sensor_type: BME280
bme280_report_time: 10
i2c_address: 118
i2c_mcu: mmu2
i2c_software_scl_pin: mmu2:PB3
i2c_software_sda_pin: mmu2:PB4

[temperature_sensor Lane_0_onboard]
sensor_type: temperature_mcu
sensor_mcu: mmu0
min_temp: 0
max_temp: 130

[temperature_sensor Lane_1_onboard]
sensor_type: temperature_mcu
sensor_mcu: mmu1
min_temp: 0
max_temp: 130

[temperature_sensor Lane_2_onboard]
sensor_type: temperature_mcu
sensor_mcu: mmu2
min_temp: 0
max_temp: 130

[temperature_sensor Lane_3_onboard]
sensor_type: temperature_mcu
sensor_mcu: mmu3
min_temp: 0
max_temp: 130

[temperature_sensor Lane_4_onboard]
sensor_type: temperature_mcu
sensor_mcu: mmu4
min_temp: 0
max_temp: 130

[temperature_sensor toolhead_board]
sensor_type: temperature_mcu
sensor_mcu: EBBCan
min_temp: 0
max_temp: 140


#[display MMU_LANE_0]
#lcd_type: ssd1306
#i2c_mcu: mmu2
#i2c_software_scl_pin: mmu2:PB3
#i2c_software_sda_pin: mmu2:PB4
#display_group: mmu_env


#[display_data mmu_env line0]
#position: 0,0
#text:
#  RH: { printer["bme280 Lane_0"].humidity|float|round(1) } %

#[display_data mmu_env line1]
#position: 1,0
#text:
#  Spool: { {0:'Empty',1:'Avail.',2:'Avail.',-1:'Unknown'}[printer.mmu.gate_status[0]|int] }

# THIRD LINE → show only when gate 0 is selected; if Unloaded, show material instead
#[display_data mmu_env line2]
#position: 2,0
#text:
#  { "Fil: Loaded" if (printer.mmu.gate|int == 0 and printer.mmu.filament == 'Loaded')
#    else ("Fil: " ~ (printer.mmu.gate_material[0]|default('—'))) }


# LAST LINE → operation (if not empty) else print state; if both empty -> Idle; only when gate 0 selected, else "--"
#[display_data mmu_env line3]
#position: 3,0
#text:
#  { 
#    (
#      printer.mmu.operation
#      if printer.mmu.operation
#      else (
#        printer.mmu.print_job_state
#        if printer.mmu.print_job_state
#        else (printer.mmu.print_state if printer.mmu.print_state else "Idle")
#      )
#    )
#    if (printer.mmu.gate|int == 0) else "--"
#  }



[gcode_macro MMU_DEBUG]
description: Show key MMU state in console
gcode:
  RESPOND MSG="Op: {printer.mmu.operation}"
  RESPOND MSG="Gate: {printer.mmu.gate}"
  RESPOND MSG="Print state: {printer.mmu.print_job_state}"
  RESPOND MSG="Filament: {printer.mmu.filament}"


# Happy Hare LED Overrides
[mmu_led_effect mmu_static_white]
define_on:    gates
layers:       static 0 0 top (1,1,1)

[mmu_led_effect mmu_static_white_dim]
define_on:    gates
layers:       static 0 0 top (0.3,0.3,0.3)

[mmu_led_effect mmu_ready_white]
define_on:    gates
layers:       breathing 2 0 subtract (0.4,0.4,0.4)
              static 0 0 top (0.5,0.5,0.5)

[mmu_led_effect mmu_ready_red]
define_on:    gates
layers:       breathing 2 0 subtract (0.4,0.0,0.0)
              static 0 0 top (0.5,0.0,0.0)


#####################################################################
#   Stepper current delayed gcode and notification infrastructure
#####################################################################

[gcode_macro MR_NOTIFY]
description: Allows you to send a custom notification via Mobileraker without using the M117 command
gcode:
    {% set msg = "MR_NOTIFY:" ~ (params.TITLE ~ "|" if 'TITLE' in params|upper else "") ~ params.MESSAGE %}

    {% if 'MESSAGE' in params|upper %}
        { action_respond_info(msg) }
    {% else %}
        { action_raise_error('Must provide MESSAGE parameter') }
    {% endif %}

[delayed_gcode INITIALISATION_MACROS] 
initial_duration: 2
gcode:
  _SET_PRINT_CURRENT
  M84
  M400
  REFRESH_SPOOLMAN
  M400
  update_git
  M400

[gcode_macro update_git]
gcode:
  RUN_SHELL_COMMAND CMD=update_git_script

[gcode_shell_command update_git_script]
command: bash -c "bash $HOME/klipper-backup/script.sh"
timeout: 180.0
verbose: False

## Timelapse
[include timelapse.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 27.137
#*# pid_ki = 2.783
#*# pid_kd = 66.144
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 63.172
#*# pid_ki = 4.342
#*# pid_kd = 229.789
#*#
#*# [cartographer scan_model default]
#*# coefficients = 1.359970193303622,1.8186060378822904,0.8080718741931734,0.37731070280707457,0.5855803397213453,0.7149469817943342,-0.4444768396171237,-0.7278668842643472,0.49123332415330934,0.5185155918559101
#*# domain = 3.1384075662764236e-07,3.32558826345892e-07
#*# z_offset = -0.01
#*#
#*# [cartographer touch_model default]
#*# threshold = 2250
#*# speed = 2
#*# z_offset = -0.095
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.118899, 0.120197, 0.127508, 0.131621, 0.130012, 0.122378, 0.114198, 0.120936, 0.127663, 0.134276, 0.133559, 0.133208, 0.129917, 0.135493, 0.133608, 0.122820, 0.116415, 0.114396, 0.118571, 0.122739, 0.117864
#*# 	0.090296, 0.099202, 0.109415, 0.110714, 0.107562, 0.101356, 0.093099, 0.096844, 0.106669, 0.111826, 0.114128, 0.110602, 0.108860, 0.108441, 0.112692, 0.104575, 0.099659, 0.100795, 0.103372, 0.102971, 0.099592
#*# 	0.061333, 0.068804, 0.079227, 0.085120, 0.081732, 0.073997, 0.071798, 0.075577, 0.082323, 0.089060, 0.089936, 0.091032, 0.089051, 0.084155, 0.091304, 0.087908, 0.081225, 0.082373, 0.083613, 0.080115, 0.070492
#*# 	0.033571, 0.041109, 0.050183, 0.062325, 0.057434, 0.052526, 0.047190, 0.047883, 0.051689, 0.061698, 0.062390, 0.066550, 0.067609, 0.074870, 0.069807, 0.069289, 0.064209, 0.062435, 0.058814, 0.058507, 0.047124
#*# 	0.010299, 0.019471, 0.039290, 0.043706, 0.035826, 0.026142, 0.025458, 0.026151, 0.027032, 0.035294, 0.040594, 0.041623, 0.045971, 0.050131, 0.048011, 0.047557, 0.044008, 0.040554, 0.036905, 0.033527, 0.029962
#*# 	-0.010214, 0.000617, 0.014565, 0.025117, 0.020124, 0.015121, 0.006699, 0.004218, 0.004910, 0.011761, 0.015802, 0.019870, 0.024122, 0.031259, 0.032442, 0.028797, 0.022045, 0.016962, 0.014968, 0.014474, 0.007873
#*# 	-0.018096, -0.002556, 0.006575, 0.012616, 0.007681, -0.000540, -0.006021, -0.010024, -0.004451, -0.003943, 0.003117, 0.010455, 0.017788, 0.021948, 0.022935, 0.017671, 0.010981, 0.004181, 0.002271, 0.004981, 0.001380
#*# 	-0.026005, -0.012010, -0.001258, 0.000041, -0.001839, -0.006909, -0.013821, -0.021141, -0.017240, -0.013529, -0.000065, 0.007462, 0.014615, 0.017186, 0.015075, 0.006678, -0.000136, -0.003749, -0.007367, -0.004551, -0.004952
#*# 	-0.029213, -0.018396, -0.010619, -0.009506, -0.011305, -0.016309, -0.021833, -0.027571, -0.023661, -0.016548, -0.009452, -0.002189, 0.005069, 0.006038, 0.000785, -0.006165, -0.012917, -0.013408, -0.015334, -0.010983, -0.014430
#*# 	-0.029213, -0.015108, -0.007617, -0.007912, -0.009803, -0.010007, -0.018625, -0.017933, -0.017330, -0.013344, -0.009452, 0.001001, 0.008255, 0.006223, 0.000785, -0.009380, -0.011304, -0.013408, -0.013628, -0.010983, -0.014520
#*# 	-0.029213, -0.012102, -0.001258, 0.000041, -0.001839, -0.003722, -0.012314, -0.008334, -0.003043, -0.002350, -0.000065, 0.008866, 0.011437, 0.010822, 0.007188, 0.000265, -0.001649, -0.005358, -0.005759, -0.002945, -0.009683
#*# 	-0.035643, -0.023104, -0.007617, 0.000041, -0.001839, -0.003722, -0.012222, -0.011715, -0.004636, -0.000757, 0.000028, 0.001001, 0.005069, 0.004533, 0.003989, -0.002948, -0.006566, -0.006967, -0.008975, -0.007768, -0.011294
#*# 	-0.037251, -0.021502, -0.007525, 0.001627, 0.002834, 0.002637, -0.005836, -0.003735, -0.006139, -0.000757, 0.003117, 0.001094, 0.003659, 0.006131, 0.003989, 0.000265, -0.004957, -0.005358, -0.004059, 0.000266, -0.011204
#*# 	-0.029213, -0.015108, -0.001258, 0.006383, 0.009172, 0.007303, 0.003525, 0.004218, 0.001733, 0.005603, 0.006295, 0.002502, 0.011437, 0.015597, 0.013389, 0.009692, 0.003073, 0.002582, 0.003780, 0.001870, -0.003345
#*# 	-0.019694, -0.005734, 0.005084, 0.014194, 0.017162, 0.015213, 0.009867, 0.010468, 0.008083, 0.008776, 0.009468, 0.007277, 0.014615, 0.015597, 0.016575, 0.013072, 0.007784, 0.004181, 0.002271, 0.001870, -0.003345
#*# 	-0.003762, 0.006951, 0.017528, 0.028165, 0.029554, 0.024570, 0.022500, 0.023192, 0.020733, 0.021243, 0.018779, 0.019962, 0.024122, 0.028282, 0.029277, 0.024035, 0.017270, 0.012270, 0.008674, 0.008273, 0.001374
#*# 	0.011877, 0.020948, 0.026957, 0.034527, 0.041980, 0.037124, 0.036353, 0.034003, 0.029986, 0.030679, 0.028228, 0.035531, 0.038120, 0.040708, 0.037089, 0.028797, 0.022045, 0.018462, 0.013280, 0.014567, 0.007780
#*# 	0.018173, 0.028800, 0.036355, 0.043706, 0.043539, 0.043185, 0.038012, 0.038704, 0.037738, 0.036959, 0.037463, 0.041811, 0.047443, 0.046990, 0.041720, 0.031966, 0.025223, 0.018462, 0.014875, 0.017661, 0.014073
#*# 	0.028973, 0.041109, 0.048631, 0.051482, 0.051227, 0.046396, 0.047190, 0.047976, 0.045645, 0.044683, 0.046842, 0.052655, 0.058280, 0.057855, 0.051150, 0.041355, 0.031565, 0.027995, 0.024421, 0.024020, 0.023620
#*# 	0.053696, 0.059543, 0.064026, 0.062325, 0.060531, 0.061736, 0.062717, 0.060313, 0.064102, 0.061512, 0.063846, 0.069461, 0.070617, 0.071769, 0.063576, 0.056980, 0.048727, 0.045181, 0.043207, 0.039843, 0.039442
#*# 	0.073654, 0.081085, 0.085352, 0.086742, 0.084796, 0.086095, 0.090226, 0.087859, 0.088367, 0.086087, 0.086688, 0.090940, 0.092124, 0.093211, 0.088315, 0.078618, 0.072002, 0.068487, 0.071200, 0.069242, 0.067285
#*# min_x = 20.0
#*# min_y = 22.0
#*# max_x = 330.0
#*# max_y = 308.0
#*# x_count = 21
#*# y_count = 21
#*# mesh_x_pps = 0
#*# mesh_y_pps = 0
#*# algo = bicubic
#*# tension = 0.2
#*#
#*# [cartographer]
#*# z_backlash = 0.003869346235626514
