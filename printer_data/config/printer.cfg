[respond]
[include chopper_tune.cfg]
#####################################################################
#   Happy Hare includes
#####################################################################
[include mmu/optional/mmu_menu.cfg]
[include mmu/base/*.cfg]
[include mmu/addons/mmu_eject_buttons.cfg]

#####################################################################
#   File locations and on error handling
#####################################################################

[virtual_sdcard]
path: /home/pi/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

 
#####################################################################
#   Printer mainboard and toolhead CAN ID's
#####################################################################
[mcu]
canbus_uuid: c0f599d7bb14
canbus_interface: can1

[mcu toolhead_mcu]
canbus_uuid: cd407005594f 
canbus_interface: can1

#####################################################################
#   Basic Klipper and Printer setup
#####################################################################

[printer]
kinematics: corexy
max_velocity: 500
max_accel: 20000   	
max_z_velocity: 35		
max_z_accel: 350	
square_corner_velocity: 5
minimum_cruise_ratio: 0.1

[exclude_object]
[print_stats]

[gcode_arcs]
resolution: 0.05

[idle_timeout]
timeout: 43200

[force_move]
enable_force_move: True


#####################################################################
#   Includes
#####################################################################

## Configuration files
[include mainsail.cfg]
[include config/toolhead_leds.cfg]
[include config/extruder.cfg]
[include config/steppers.cfg]
[include config/temperature_sensors.cfg]
[include config/homing.cfg]
[include config/fans.cfg]
[include config/disco.cfg]
[include config/input_shaper.cfg]
[include config/display.cfg]

## Macros
[include macros/stealthmax_macros.cfg]
[include macros/movement_macros.cfg]
[include macros/LED_macros.cfg]
[include macros/printing_macros.cfg]
[include macros/print_start_end.cfg]

## Cartographer macro
[include macros/cartographer_macros.cfg]

## MMU Macros
[include mmu/optional/client_macros.cfg]
[include mmu/addons/blobifier.cfg]
[include macros/custom_blobifier.cfg]
[include macros/custom_mmu_macros.cfg]

[include macros/emu_macros.cfg]


[temperature_sensor toolhead_board]
sensor_type: temperature_mcu
sensor_mcu: toolhead_mcu
min_temp: 0
max_temp: 140

[gcode_macro DUMP_FLOWGUARD]
description: Dump printer['mmu'].flowguard
gcode:
  {% set fg = printer['mmu'].flowguard %}
  {action_respond_info("mmu.flowguard = " ~ fg|string)}


[gcode_macro QUERY_HUMIDITY_SENSORS]
description: Auto-detect humidity-capable sensors and report their readings
gcode:
  {% set ns = namespace(lines=[]) %}

  # Loop over all printer objects; keep the ones that expose `.humidity`
  {% for name in printer|sort %}
    {% set obj = printer[name] %}
    {% if obj.humidity is defined and obj.humidity is not none %}
      {% if obj.temperature is defined and obj.temperature is not none %}
        {% set ns.lines = ns.lines + [ "%s: %.2f°C  %.2f%%RH" % (name, obj.temperature, obj.humidity) ] %}
      {% else %}
        {% set ns.lines = ns.lines + [ "%s: %.2f%%RH" % (name, obj.humidity) ] %}
      {% endif %}
    {% endif %}
  {% endfor %}

  {% if ns.lines|length == 0 %}
    {action_respond_info(
      "No humidity-capable sensors found.\n"
      "Tip: BME280/HTU21D/SHT3X typically appear as objects like:\n"
      "  bme280 <name>, htu21d <name>, sht3x <name>\n"
      "and expose `.humidity`."
    )}
  {% else %}
    {action_respond_info("Humidity sensors:\n" ~ (ns.lines|join("\n")))}
    {% if params.DISPLAY|default(0)|int == 1 %}
      SET_DISPLAY_TEXT MSG="{ns.lines[0]}"
    {% endif %}
  {% endif %}



#[display MMU_LANE_0]
#lcd_type: ssd1306
#i2c_mcu: mmu2
#i2c_software_scl_pin: mmu2:PB3
#i2c_software_sda_pin: mmu2:PB4
#display_group: mmu_env


#[display_data mmu_env line0]
#position: 0,0
#text:
#  RH: { printer["bme280 Lane_0"].humidity|float|round(1) } %

#[display_data mmu_env line1]
#position: 1,0
#text:
#  Spool: { {0:'Empty',1:'Avail.',2:'Avail.',-1:'Unknown'}[printer.mmu.gate_status[0]|int] }

# THIRD LINE → show only when gate 0 is selected; if Unloaded, show material instead
#[display_data mmu_env line2]
#position: 2,0
#text:
#  { "Fil: Loaded" if (printer.mmu.gate|int == 0 and printer.mmu.filament == 'Loaded')
#    else ("Fil: " ~ (printer.mmu.gate_material[0]|default('—'))) }


# LAST LINE → operation (if not empty) else print state; if both empty -> Idle; only when gate 0 selected, else "--"
#[display_data mmu_env line3]
#position: 3,0
#text:
#  { 
#    (
#      printer.mmu.operation
#      if printer.mmu.operation
#      else (
#        printer.mmu.print_job_state
#        if printer.mmu.print_job_state
#        else (printer.mmu.print_state if printer.mmu.print_state else "Idle")
#      )
#    )
#    if (printer.mmu.gate|int == 0) else "--"
#  }



[gcode_macro MMU_DEBUG]
description: Show key MMU state in console
gcode:
  RESPOND MSG="Op: {printer.mmu.operation}"
  RESPOND MSG="Gate: {printer.mmu.gate}"
  RESPOND MSG="Print state: {printer.mmu.print_job_state}"
  RESPOND MSG="Filament: {printer.mmu.filament}"
  RESPOND MSG="Flow rate {printer.mmu.sync_feedback_flow_rate}"
  RESPOND msg="Flowguard enabled: {printer.mmu.flowguard.enabled}"



#####################################################################
#   Stepper current delayed gcode and notification infrastructure
#####################################################################

[gcode_macro MR_NOTIFY]
description: Allows you to send a custom notification via Mobileraker without using the M117 command
gcode:
    {% set msg = "MR_NOTIFY:" ~ (params.TITLE ~ "|" if 'TITLE' in params|upper else "") ~ params.MESSAGE %}

    {% if 'MESSAGE' in params|upper %}
        { action_respond_info(msg) }
    {% else %}
        { action_raise_error('Must provide MESSAGE parameter') }
    {% endif %}

[delayed_gcode INITIALISATION_MACROS] 
initial_duration: 3
gcode:
  _SET_PRINT_CURRENT
  M84
  M400
  REFRESH_SPOOLMAN
  M400
  update_git
  M400

[gcode_macro update_git]
gcode:
  RUN_SHELL_COMMAND CMD=update_git_script

[gcode_shell_command update_git_script]
command: bash -c "bash $HOME/klipper-backup/script.sh"
timeout: 320.0
verbose: False

## Timelapse
[include timelapse.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 25.994
#*# pid_ki = 2.666
#*# pid_kd = 63.358
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 63.172
#*# pid_ki = 4.342
#*# pid_kd = 229.789
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.006571, 0.008624, 0.009831, 0.013087, 0.010946, 0.013087, 0.013271, 0.017542, 0.017542, 0.019764, 0.020782, 0.019764, 0.017542, 0.016520, 0.015313, 0.010854, 0.008716, 0.007597, 0.009831, 0.011038, 0.013087
#*# 	  0.008808, 0.010854, 0.011971, 0.012063, 0.013271, 0.012063, 0.013271, 0.016428, 0.014200, 0.016520, 0.017634, 0.017542, 0.017542, 0.015313, 0.013179, 0.011038, 0.008808, 0.006478, 0.009831, 0.013087, 0.015313
#*# 	  0.005361, 0.006571, 0.011038, 0.010854, 0.008624, 0.008624, 0.008808, 0.008716, 0.008716, 0.008808, 0.009739, 0.011038, 0.011038, 0.008808, 0.006571, 0.002094, -0.000145, -0.000145, 0.002094, 0.007597, 0.008808
#*# 	  0.005361, 0.007689, 0.006571, 0.008624, 0.005361, 0.007597, 0.007597, 0.006571, 0.006478, 0.006571, 0.008808, 0.011038, 0.011038, 0.008716, 0.005361, 0.002094, -0.000145, -0.003511, -0.001266, 0.006571, 0.008808
#*# 	  0.008808, 0.012063, 0.010854, 0.008808, 0.007597, 0.006571, 0.006478, 0.006478, 0.006571, 0.006571, 0.008624, 0.011038, 0.010854, 0.008808, 0.006571, 0.004336, 0.002094, -0.000145, 0.004243, 0.010854, 0.013087
#*# 	  0.005361, 0.009831, 0.007597, 0.005453, 0.005361, 0.005361, 0.004336, 0.004336, 0.004336, 0.006571, 0.008716, 0.010946, 0.011971, 0.011038, 0.008808, 0.004336, 0.004336, 0.002094, 0.004336, 0.013179, 0.017542
#*# 	  -0.000145, 0.008716, 0.008716, 0.006571, 0.004336, 0.004336, 0.002094, 0.000884, 0.004336, 0.006478, 0.008624, 0.015313, 0.014292, 0.013179, 0.013087, 0.008624, 0.006386, 0.006478, 0.009831, 0.017542, 0.021988
#*# 	  -0.001266, 0.007597, 0.008716, 0.007689, 0.005361, 0.001067, -0.001176, -0.002206, -0.000145, 0.002094, 0.007597, 0.010854, 0.013087, 0.013087, 0.010854, 0.008808, 0.006386, 0.005361, 0.008808, 0.016520, 0.021988
#*# 	  -0.002387, 0.005453, 0.006571, 0.005361, -0.000145, -0.004636, -0.006701, -0.006791, -0.004543, -0.002387, 0.002186, 0.006571, 0.008716, 0.008808, 0.006571, 0.004336, 0.002094, 0.002094, 0.006478, 0.013087, 0.015497
#*# 	  -0.004636, 0.004336, 0.008624, 0.004336, -0.001266, -0.006791, -0.006882, -0.006791, -0.006882, -0.002387, 0.002094, 0.006571, 0.008808, 0.008808, 0.008716, 0.006386, 0.004336, 0.006571, 0.008808, 0.015313, 0.015497
#*# 	  -0.005575, 0.006478, 0.008624, 0.006571, -0.000145, -0.006882, -0.008949, -0.009042, -0.007915, -0.006701, -0.000145, 0.004336, 0.007597, 0.009831, 0.008808, 0.006478, 0.005453, 0.004336, 0.008808, 0.013087, 0.015313
#*# 	  -0.010260, 0.002094, 0.006478, 0.003122, -0.002387, -0.005668, -0.009135, -0.011199, -0.011199, -0.008949, -0.002387, 0.003215, 0.005361, 0.006571, 0.006571, 0.004336, 0.004336, 0.003122, 0.006571, 0.013087, 0.015313
#*# 	  -0.010167, -0.000145, 0.004151, 0.002094, -0.002387, -0.006791, -0.009135, -0.011199, -0.012421, -0.011199, -0.005666, -0.001266, 0.003215, 0.002094, 0.002094, 0.001067, 0.000040, 0.000974, 0.004336, 0.008716, 0.010854
#*# 	  -0.010167, -0.000145, 0.003215, 0.003125, -0.001266, -0.006882, -0.010167, -0.013457, -0.013457, -0.013457, -0.008949, -0.002387, -0.000145, 0.002094, -0.000145, -0.000145, -0.000145, -0.000145, 0.004336, 0.007597, 0.008808
#*# 	  -0.005668, 0.006386, 0.008808, 0.006571, 0.002094, -0.002387, -0.006791, -0.011292, -0.011199, -0.008949, -0.004636, 0.000974, 0.002094, 0.004336, 0.004336, 0.004243, 0.003215, 0.003215, 0.006571, 0.009831, 0.008808
#*# 	  -0.007825, 0.006571, 0.010854, 0.005453, 0.002094, -0.003419, -0.006791, -0.010167, -0.010167, -0.006701, -0.002387, 0.002094, 0.004336, 0.006571, 0.006571, 0.006571, 0.004336, 0.004336, 0.004336, 0.008716, 0.008624
#*# 	  -0.003419, 0.010854, 0.017542, 0.013087, 0.008716, 0.004336, -0.000145, -0.001176, -0.002297, -0.000145, 0.005453, 0.010946, 0.013087, 0.015313, 0.015313, 0.015313, 0.013087, 0.010854, 0.013087, 0.015313, 0.015313
#*# 	  -0.000145, 0.014200, 0.021894, 0.017726, 0.013087, 0.008808, 0.004336, 0.002094, 0.002094, 0.004336, 0.009831, 0.015313, 0.017542, 0.019764, 0.018653, 0.017542, 0.015313, 0.013087, 0.014200, 0.017542, 0.016428
#*# 	  -0.000145, 0.013087, 0.019764, 0.017542, 0.010854, 0.006386, -0.000145, -0.002387, -0.002297, -0.000145, 0.004336, 0.011038, 0.014292, 0.015313, 0.015313, 0.015313, 0.010946, 0.008624, 0.008808, 0.011038, 0.010854
#*# 	  0.000974, 0.015313, 0.023005, 0.021988, 0.013271, 0.006478, -0.000145, -0.002387, -0.000145, 0.002094, 0.006571, 0.013087, 0.013087, 0.017542, 0.015405, 0.013087, 0.013179, 0.010854, 0.010854, 0.010946, 0.013271
#*# 	  0.002094, 0.013087, 0.019764, 0.017542, 0.015313, 0.006571, 0.002094, -0.000145, -0.001176, 0.000884, 0.004336, 0.010854, 0.013087, 0.013271, 0.013087, 0.011038, 0.006571, 0.006571, 0.004336, 0.007597, 0.008808
#*# min_x = 20.0
#*# min_y = 22.0
#*# max_x = 330.0
#*# max_y = 330.0
#*# x_count = 21
#*# y_count = 21
#*# mesh_x_pps = 0
#*# mesh_y_pps = 0
#*# algo = bicubic
#*# tension = 0.2
#*#
#*# [cartographer]
#*# z_backlash = 0.01097
#*#
#*# [cartographer scan_model default]
#*# coefficients = 1.3759739318343394,1.845207543616375,0.8349319639609626,0.40255477926256794,0.509819560944253,0.5871480866142801,-0.3342572961153586,-0.5610691736099757,0.41338834173310895,0.42705459536948165
#*# domain = 3.1657800209736596e-07,3.3319526671404467e-07
#*# z_offset = 0
#*# reference_temperature = 32.04
#*# software_version = 1.1.0
#*# mcu_version = CARTOGRAPHER 5.1.0
#*#
#*# [cartographer touch_model default]
#*# threshold = 2360
#*# speed = 2
#*# z_offset = -0.05
#*# software_version = 1.3.3
#*# mcu_version = CARTOGRAPHER 5.1.0
